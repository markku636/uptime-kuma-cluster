stages:
  - check
  - build
  - deploy
  - cleanup

variables:
  IMAGE: ${AZURE_CONTAINER_REGISTRY_URL}${CI_REGISTRY_IMAGE}:${CI_PIPELINE_ID}

check_network:
  stage: check
  script:
    # 檢查網路是否存在，若不存在則建立為 Docker bridge 網路
    - docker network ls

    - |
      NETWORK_NAME="kuma-network"
      echo "Checking for network: ${NETWORK_NAME}"
      if ! docker network inspect ${NETWORK_NAME} > /dev/null 2>&1; then
        echo "Network ${NETWORK_NAME} not found. Creating Docker bridge network..."
        docker network create --driver bridge ${NETWORK_NAME}
      else
        echo "Network ${NETWORK_NAME} already exists."
      fi
  tags:
    - Development.IISI_Banqiao.docker
  allow_failure: false

check_remote_directory:
  stage: check
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -p "$DEPLOY_PORT" -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "開始檢查遠端主機 $DEPLOY_HOST ..."
    - echo "REMOTE_DIRS = $REMOTE_DIRS"
    - |
      for DIR in $REMOTE_DIRS; do
        echo "=== 檢查並建立: $DIR ==="
        ssh -p "$DEPLOY_PORT" -i ~/.ssh/id_rsa $DEPLOY_USER@$DEPLOY_HOST "
          set -e
          if [ ! -d '$DIR' ]; then
            echo '$DIR 資料夾不存在，正在建立...';
            sudo mkdir -p '$DIR';
          else
            echo '$DIR 資料夾已存在';
          fi

          sudo chmod 775 '$DIR'
          echo '已將 $DIR 權限設為 775'
        "
      done
  tags:
    - Development.IISI_Banqiao.docker
  variables:
    REMOTE_DIRS: "/data/volume/uptimekuma"

build:
  stage: build
  image:
    name: docker:latest
    entrypoint: [""]
  before_script:
    - echo ${AZURE_CONTAINER_REGISTRY_KEY} | docker login ${AZURE_CONTAINER_REGISTRY_URL} -u ${AZURE_CONTAINER_REGISTRY_USER} --password-stdin
  script:
    - docker build
      --target release
      -f docker/dockerfile
      -t ${IMAGE}
      .
    - echo "Docker image built successfully"
    - docker push ${IMAGE}
  only:
    - main
  tags:
    - Development.IISI_Banqiao.docker

deploy:
  stage: deploy
  image:
    name: docker:latest
    entrypoint: [""]
  before_script:
    - echo ${AZURE_CONTAINER_REGISTRY_KEY} | docker login ${AZURE_CONTAINER_REGISTRY_URL} -u ${AZURE_CONTAINER_REGISTRY_USER} --password-stdin
  script:
    - docker compose -f docker-compose-dual-node.yaml down --remove-orphans
    - docker compose -f docker-compose-dual-node.yaml pull
    - docker compose -f docker-compose-dual-node.yaml up -d --force-recreate
  only:
    - main
  tags:
    - Development.IISI_Banqiao.docker

verify:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    # 1) 找出 compose 產生的 container IDs
    - CONTAINERS=$(docker ps --filter "label=com.docker.compose.project=$(basename $CI_PROJECT_NAME)" --format "{{.ID}}")
    - echo "等待服務變成 healthy ..."
    # 2) 最長等 180 秒；只要有一個 unhealthy 就失敗
    - |
      TIMEOUT=180
      START=$(date +%s)
      while true; do
        UNHEALTHY=0
        for ID in $CONTAINERS; do
          STATE=$(docker inspect -f '{{ .State.Health.Status }}' $ID || echo none)
          if [ "$STATE" != "healthy" ]; then
            UNHEALTHY=1
            break
          fi
        done
        if [ $UNHEALTHY -eq 0 ]; then
          echo "所有服務均為 healthy"
          break
        fi
        NOW=$(date +%s)
        if [ $((NOW-START)) -gt $TIMEOUT ]; then
          echo "⚠️  服務未在 ${TIMEOUT}s 內 Healthy，佈署失敗"; exit 1
        fi
        sleep 5
      done
  tags:
    - Development.IISI_Banqiao.docker
  allow_failure: false

cleanup_old_images:
  stage: cleanup
  image:
    name: docker:latest
    pull_policy: always
    entrypoint: [ "" ]
  script:
    - >
      REPO="$AZURE_CONTAINER_REGISTRY_URL$CI_REGISTRY_IMAGE/$CI_BUILD_REF_NAME";
      KEEP=$KEEP_VERSIONS;
      echo "開始清理 ${REPO} 舊版映像檔，只保留最新 ${KEEP} 個版本";
      TOTAL=$(docker images --format "{{.Repository}} {{.Tag}} {{.ID}}" | grep "${REPO}" | wc -l);
      echo "總共找到 ${TOTAL} 個版本";
      REMOVE_COUNT=$((TOTAL - KEEP));
      if [ "$REMOVE_COUNT" -gt 0 ]; then
        echo "需要刪除 ${REMOVE_COUNT} 個舊版本";
        IMAGES=$(docker images --format "{{.Repository}} {{.Tag}} {{.ID}}" | grep "${REPO}" | sort -k2 -n | head -n ${REMOVE_COUNT} | awk '{print $3}');
        for image in $IMAGES; do
          echo "刪除映像檔：$image";
          docker rmi --force $image || true;
        done;
      else
        echo "沒有需要刪除的舊版本映像檔";
      fi
  tags:
    - Development.IISI_Banqiao.docker
  variables:
    KEEP_VERSIONS: 3
  when: on_success
