# 節點管理功能實現總結

## 概述
成功將 `UPTIME_KUMA_NODE_ID` 從環境變數移至資料庫，並實作了完整的節點管理功能。系統現在支援完整的節點狀態監控、心跳檢測、版本管理和主節點選舉功能。

## 已實現的功能

### 1. 資料庫遷移
- **文件**: `db/knex_migrations/2025-07-01-0000-create-nodes.js`
- **功能**: 創建 `node` 表，包含以下欄位：
  - `id`: 主鍵
  - `node_id`: 節點 ID（唯一）
  - `node_name`: 節點名稱
  - `ip`: IP 地址（可選）
  - `created_date`: 創建時間
  - `modified_date`: 修改時間

- **文件**: `db/knex_migrations/2025-07-02-0000-add-primary-node.js`
- **功能**: 添加主節點標識欄位：
  - `is_primary`: 是否為主節點（布林值，預設 false）

- **文件**: `db/knex_migrations/2025-07-03-0000-add-node-status.js`
- **功能**: 添加節點狀態監控欄位：
  - `status`: 節點狀態（字串，預設 'unknown'）
  - `last_heartbeat`: 最後心跳時間
  - `last_error_message`: 最後錯誤訊息

- **文件**: `db/knex_migrations/2025-07-04-0000-add-node-version.js`
- **功能**: 添加節點版本管理欄位：
  - `version`: 節點版本（字串，可選）

### 2. Node Model
- **文件**: `server/model/node.js`
- **功能**:
  - 完整的 CRUD 操作
  - 自動從環境變數初始化節點記錄
  - 靜態方法用於獲取當前節點信息
  - 主節點管理（設置/清除主節點標識）
  - 節點狀態管理（上線/離線/錯誤狀態）
  - 心跳更新和錯誤記錄
  - 版本管理
  - JSON 格式轉換

### 3. 節點管理器 (NodeManager)
- **文件**: `server/node-manager.js`
- **功能**:
  - 自動心跳發送（預設30秒間隔）
  - 節點狀態檢查（預設60秒間隔）
  - 故障轉移處理（當節點離線時自動轉移監控器）
  - 監控器負載平衡
  - 手動觸發重新平衡
  - 節點健康狀態監控

### 4. 後端 API
- **文件**: `server/socket-handlers/node-socket-handler.js`
- **功能**:
  - `getNodeList`: 獲取所有節點列表
  - `addNode`: 新增節點
  - `updateNode`: 更新節點信息
  - `deleteNode`: 刪除節點（有監控器分配的節點無法刪除）
  - `setPrimaryNode`: 設置主節點
  - `getNodeStatus`: 獲取節點狀態
  - `triggerRebalancing`: 手動觸發監控器重新平衡

### 5. 伺服器啟動邏輯更新
- **文件**: `server/uptime-kuma-server.js`
- **功能**: 伺服器啟動時自動檢查並創建節點記錄
- **文件**: `server/server.js`
- **功能**: 集成節點 socket handler 和發送節點列表
- **文件**: `server/node-manager.js`
- **功能**: 自動啟動節點管理器，開始心跳和狀態監控

### 6. 客戶端支援
- **文件**: `server/client.js`
- **功能**: 添加 `sendNodeList` 函數和節點列表事件處理

### 7. 前端管理頁面
- **文件**: `src/components/settings/Nodes.vue`
- **功能**:
  - 節點列表顯示（包含狀態、心跳、版本、主節點標識）
  - 新增節點對話框（支援版本和主節點設置）
  - 編輯節點功能
  - 刪除節點功能
  - 當前節點標識
  - 節點狀態指示器
  - 主節點標識顯示
  - 手動重新平衡按鈕
  - 響應式設計

### 8. 路由配置
- **文件**: `src/router.js`
- **功能**: 添加節點管理頁面路由

### 9. 設定頁面集成
- **文件**: `src/pages/Settings.vue`
- **功能**: 在設定菜單中添加節點管理選項

### 10. 全域狀態管理
- **文件**: `src/mixins/socket.js`
- **功能**: 添加 `nodeList` 到全域狀態和事件處理

## 環境變數支援

系統現在支援以下環境變數：
- `UPTIME_KUMA_NODE_ID` 或 `NODE_ID`: 節點 ID
- `UPTIME_KUMA_NODE_NAME` 或 `NODE_NAME`: 節點名稱（可選）
- `UPTIME_KUMA_NODE_IP` 或 `NODE_IP`: 節點 IP（可選）
- `UPTIME_KUMA_NODE_VERSION` 或 `NODE_VERSION`: 節點版本（可選）

## 自動初始化

當伺服器啟動時：
1. 檢查是否設定了 `UPTIME_KUMA_NODE_ID`
2. 如果設定了，檢查資料庫中是否存在該節點
3. 如果不存在，自動創建節點記錄
4. 使用環境變數中的名稱、IP和版本，如果沒有設定則使用預設值
5. 自動啟動節點管理器，開始心跳和狀態監控

## 節點狀態管理

### 狀態類型
- `online`: 節點正常運行
- `offline`: 節點離線或無法連接
- `error`: 節點出現錯誤
- `unknown`: 節點狀態未知（初始狀態）

### 心跳機制
- 每個節點每30秒發送一次心跳
- 如果節點超過60秒沒有心跳，標記為離線
- 離線節點的監控器會自動轉移到其他在線節點

### 故障轉移
- 當節點離線時，自動檢測受影響的監控器
- 將監控器重新分配給其他在線節點
- 支援負載平衡，確保監控器均勻分布

## 主節點管理

### 主節點功能
- 系統中只能有一個主節點
- 主節點負責協調其他節點
- 支援手動設置和自動選舉
- 主節點離線時自動選舉新的主節點

### 主節點選舉規則
- 優先選擇在線時間最長的節點
- 其次選擇監控器數量最少的節點
- 最後選擇節點ID字母順序

## 監控器過濾和分配

更新的監控器過濾邏輯：
- 繼續支援基於 `UPTIME_KUMA_NODE_ID` 的過濾
- 增加了資料庫節點信息的查詢和日誌
- 向前端發送當前節點的詳細信息
- 支援監控器的動態重新分配
- 自動負載平衡功能

## 使用方法

### 訪問節點管理頁面
1. 登入 Uptime Kuma
2. 進入 **設定** 頁面
3. 點擊左側菜單中的 **Nodes**

### 新增節點
1. 點擊 **Add Node** 按鈕
2. 填寫節點 ID（必填，不可重複）
3. 填寫節點名稱（必填）
4. 填寫 IP 地址（可選）
5. 填寫節點版本（可選）
6. 選擇是否為主節點（可選）
7. 點擊 **Add** 保存

### 編輯節點
1. 在節點列表中點擊 **Edit** 按鈕
2. 修改節點名稱、IP地址或版本
3. 注意：節點 ID 創建後無法修改
4. 點擊 **Update** 保存

### 刪除節點
1. 在節點列表中點擊 **Delete** 按鈕
2. 確認刪除操作
3. 注意：有監控器分配的節點無法刪除

### 手動重新平衡
1. 在節點管理頁面點擊 **Rebalance Monitors** 按鈕
2. 系統會自動重新分配所有監控器
3. 確保監控器均勻分布在所有在線節點上

## 向後兼容性

- 完全向後兼容現有的環境變數配置
- 現有的 `UPTIME_KUMA_NODE_ID` 設定會自動同步到資料庫
- 不影響現有的監控器分配和過濾邏輯
- 新增的欄位都有預設值，不會影響現有數據

## 安全性

- 所有 API 操作都需要用戶登入
- 節點 ID 的唯一性由資料庫約束保證
- 防止刪除有依賴的節點
- 主節點設置需要適當權限
- 心跳和狀態更新有頻率限制

## 性能優化

- 心跳間隔可配置（預設30秒）
- 狀態檢查間隔可配置（預設60秒）
- 資料庫查詢優化，減少不必要的查詢
- 支援批量操作，提高效率

## 測試狀態

✅ 專案構建成功
✅ 所有新增的文件和修改都通過編譯
✅ SCSS 樣式問題已修復
✅ 前後端集成完成
✅ 資料庫遷移文件完整
✅ 節點管理器功能完整
✅ 故障轉移邏輯實現
✅ 負載平衡算法實現
✅ 主節點管理功能完整
✅ 心跳和狀態監控功能完整

## 下一步計劃

1. **監控器分配策略優化**
   - 實現更智能的負載平衡算法
   - 支援基於節點性能的動態分配

2. **節點健康檢查增強**
   - 添加更多健康指標（CPU、記憶體、網路等）
   - 實現預警機制

3. **集群管理功能**
   - 支援節點組管理
   - 實現節點間的通信協議

4. **監控和日誌**
   - 添加節點管理相關的監控指標
   - 實現詳細的操作日誌記錄 